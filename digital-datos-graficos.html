
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>DIGITAL - Dashboard Publicidad</title>

<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

<style>
:root{
  --card:#111827;
  --card-soft:#1f2933;
  --text:#e5e7eb;
  --muted:#9ca3af;
  --accent:#38bdf8;
  --accent2:#f59e0b;
  --down:#f87171;
  --base-color:#38bdf8;
  --comp-color:#f59e0b;
  --ok-green: #6ee7b7;

  --comercial-color:#a78bfa;
  --comercial-bg-light:#efe9ff;
  --comercial-border:#cbb6ff;
  --comercial-text:#111;
}

body{
  margin:0;
  font-family:Inter,Arial,sans-serif;
  background:linear-gradient(180deg,#020617,#0f172a);
  color:var(--text);
}

/* Estilo del Men√∫ de Navegaci√≥n */
.nav-menu {
  background: #111827;
  padding: 15px;
  text-align: center;
  border-bottom: 1px solid #374151;
  position: sticky;
  top: 0;
  z-index: 1000;
}
.nav-menu a {
  color: white;
  margin: 0 10px;
  text-decoration: none;
  font-size: 0.9em;
  opacity: 0.8;
}
.nav-menu a:hover { opacity: 1; color: var(--accent); }
/* CORRECCI√ìN: Ahora apunta correctamente a Display */
.nav-menu .active { font-weight: bold; border-bottom: 2px solid var(--accent); opacity: 1; }

h1{ text-align:center; margin:20px 0; }
.container{ max-width:1500px; margin:auto; padding:20px; }

.card{
  background:rgba(17,24,39,.85);
  border-radius:14px;
  padding:18px;
  margin-bottom:20px;
}

.filters select, input[type=file]{
  background:var(--card-soft);
  color:var(--text);
  border:1px solid #1f2937;
  padding:8px 10px;
  border-radius:8px;
  margin-right:10px;
}

.filters span.label{ font-weight:600; margin-right:5px; }
.label-base{ color:var(--base-color); }
.label-comp{ color:var(--comp-color); }

.months-container{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin-top:5px;
}
.months-container label{
  display:flex;
  align-items:center;
  gap:5px;
  cursor:pointer;
  font-size: 0.9em;
}

#comercialBlock .label-comercial{
  color:var(--comercial-color);
  font-weight:700;
  margin-right:10px;
}

#comercialBlock select#fComercial{
  background:var(--comercial-bg-light);
  color:var(--comercial-text);
  border:1px solid var(--comercial-border);
  border-radius:10px;
  font-weight:700;
  padding:8px 10px;
  outline:none;
}

.kpis{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
  gap:14px;
}
.kpi{
  text-align:center;
  padding:18px;
  background:linear-gradient(160deg,#020617,#111827);
  border-radius:12px;
}
.kpi h2{ margin:0; font-size:1.8em; color:var(--accent); }
.kpi p{ margin:6px 0 0; color:var(--muted); }
.kpi span.pct{ display:block; margin-top:4px; font-size:0.9em; font-weight:600; }

.chart{ height:680px; }
/* Estilo especial para el gr√°fico de comerciales */
#chartComercial { height: 1600px !important; } 
</style>
</head>

<body>

<nav class="nav-menu">
    <span style="color: #38bdf8; font-weight: bold; margin-right: 10px; opacity: 0.6;">DIGITAL:</span>
    <a href="digital-datos-graficos.html" class="active">Datos</a>
    <a href="digital-facturacion-desglosada.html">Desglose</a>
    <a href="digital-display.html">Display</a>
    <a href="digital-totales-familas-productos.html">Productos</a>
    
    <span style="color: #f59e0b; font-weight: bold; margin-left: 20px; margin-right: 10px; border-left: 1px solid #4b5563; padding-left: 20px;">PRINT:</span>
    <a href="print-datos-graficos.html">Datos</a>
    <a href="print-facturacion-desglosada.html">Desglose</a>
    
    <a href="index.html" style="margin-left: 20px; border-left: 1px solid #4b5563; padding-left: 20px; color: #fff; opacity: 0.5;">üè† Inicio</a>
</nav>

<h1>DIGITAL - Dashboard Publicidad</h1>

<div class="container">

  <div class="card">
    <label>Cargar datos manualmente: </label>
    <input type="file" id="fileInput" accept=".json,.xlsx">
    <p id="loadStatus" style="font-size: 0.8em; color: var(--ok-green); margin-top: 10px;"></p>
  </div>

  <div id="filters" class="card filters" style="display:none">
    <span class="label label-base">A√±o base</span> <select id="fYear"></select><br><br>
    <div id="monthContainer1" class="months-container"></div><br>
    <span class="label label-comp">A√±o comparaci√≥n</span> <select id="fYear2"></select><br><br>
    <div id="monthContainer2" class="months-container"></div>
  </div>

  <div id="comercialBlock" class="card filters" style="display:none">
    <span class="label label-comercial">Comercial</span>
    <select id="fComercial"></select>
  </div>

  <div class="card kpis" id="kpisTotals"></div>

  <div class="card">
    <h2>Ingresos por Site</h2>
    <div id="chartSite" class="chart"></div>
  </div>

  <div class="card">
    <h2>Ingresos por √Årea</h2>
    <div id="chartArea" class="chart"></div>
  </div>

  <div class="card">
    <h2>Ingresos por Sector</h2>
    <div id="chartSector" class="chart"></div>
  </div>

  <div class="card">
    <h2>Ingresos por Familia</h2>
    <div id="chartFamilia" class="chart"></div>
  </div>

  <div class="card">
    <h2>Productos de la Familia Sponsorship</h2>
    <div id="chartSponsorship" class="chart" style="height:600px;"></div>
  </div>

  <div class="card">
    <h2>Productos de la Familia Social Networks</h2>
    <div id="chartSocialNetworks" class="chart" style="height:600px;"></div>
  </div>

  <div class="card">
    <h2>Ingresos por Comercial</h2>
    <div id="chartComercial" class="chart"></div>
  </div>

</div>

<script>
let rawData=[];

/* >>>> CARGA AUTOM√ÅTICA ELIMINADA (no hay window.onload con fetch) <<<< */

fileInput.onchange=e=>{
  const f=e.target.files[0];
  if(!f) return;
  const ext=f.name.split(".").pop().toLowerCase();
  const r=new FileReader();
  r.onload=ev=>{
    if(ext==="json") init(JSON.parse(ev.target.result));
    else{
      const wb=XLSX.read(ev.target.result,{type:"binary"});
      init(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]));
    }
  };
  ext==="json"?r.readAsText(f):r.readAsBinaryString(f);
};

function init(data){
  rawData=data.map(d=>({
    ingreso:num(d["Imp.Neto a Comisionar"]),
    A√±o:String(d["A√±o inserci√≥n"]||""),
    Mes:String(d["Mes inserci√≥n"]||""),
    Site:String(d["Publicaci√≥n"]||"Sin site"),
    Familia:String(d["Familia"]||"Sin familia"),
    Subfamilia:String(d["Subfamilia"]||""),
    Area:String(d["√ÅREAS"]||"Sin √°rea"),
    Comercial:String(d["Comercial"]||"Sin comercial"),
    Producto:String(d["Producto"]||""),
    Sector:String(d["Sector"]||"Sin sector")
  }));

  const years=[...new Set(rawData.map(d=>d.A√±o).filter(Boolean))].sort((a,b)=>b-a);
  const months=[...new Set(rawData.map(d=>d.Mes).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
  const commercials=[...new Set(rawData.map(d=>d.Comercial).filter(Boolean))].sort();

  fYear.innerHTML="<option>Todos</option>"+years.map(y=>`<option>${y}</option>`).join("");
  fYear2.innerHTML="<option>Sin comparar</option>"+years.map(y=>`<option>${y}</option>`).join("");
  fComercial.innerHTML="<option>Todos</option>"+commercials.map(c=>`<option>${c}</option>`).join("");

  createMonthCheckboxes("monthContainer1",months);
  createMonthCheckboxes("monthContainer2",months);

  [fYear,fYear2,fComercial].forEach(s=>s.onchange=render);
  filters.style.display="block";
  comercialBlock.style.display="block";
  render();
}

function num(v){
  if(!v) return 0;
  return Number(v.toString().replace("‚Ç¨","").replace(/\./g,"").replace(",",".")); 
}

function createMonthCheckboxes(containerId,months){
  const container=document.getElementById(containerId);
  container.innerHTML="";
  months.forEach(m=>{
    const label=document.createElement("label");
    const input=document.createElement("input");
    input.type="checkbox";
    input.value=m; // Mantiene el "01 Enero" para el filtro
    input.onchange=render;
    
    // CORRECCI√ìN: Limpia el n√∫mero para la vista (deja solo "Enero")
    const visualMonth = m.replace(/^\d{2}\s/, ""); 
    
    label.appendChild(input);
    label.appendChild(document.createTextNode(visualMonth));
    container.appendChild(label);
  });
}

function getSelectedMonths(containerId){
  const container=document.getElementById(containerId);
  return Array.from(container.querySelectorAll("input:checked")).map(i=>i.value);
}

function filteredBy(year,months,comercial){
  return rawData.filter(d=>
    (year==="Todos" || d.A√±o===year) &&
    (months.length===0 || months.includes(d.Mes)) &&
    (comercial==="Todos" || d.Comercial===comercial)
  );
}

function render(){
  const y1=fYear.value, m1=getSelectedMonths("monthContainer1"), c1=fComercial.value;
  const y2=fYear2.value, m2=getSelectedMonths("monthContainer2"), c2=fComercial.value;

  const d1=filteredBy(y1,m1,c1);
  const d2=(y2!=="Sin comparar")?filteredBy(y2,m2,c2):[];

  const t1=d1.reduce((a,b)=>a+b.ingreso,0);
  const t2=d2.reduce((a,b)=>a+b.ingreso,0);

  let pct="";
  if(d2.length && t2>0){
    const diff=(t1-t2)/t2*100;
    pct=`<span class="pct" style="color:${diff>=0?'#6ee7b7':'#f87171'}">${diff>=0?'+':''}${diff.toFixed(0)}%</span>`;
  }

  kpisTotals.innerHTML="";
  kpi(kpisTotals,"Total "+y1,t1,pct);
  kpi(kpisTotals,"Total "+y2,t2);

  drawCompareChart("chartSite","Site",d1,d2,y1,y2,true);
  drawCompareChart("chartArea","Area",d1,d2,y1,y2,true);
  drawCompareChart("chartSector","Sector",d1,d2,y1,y2,true);
  drawCompareChart("chartFamilia","Familia",d1,d2,y1,y2,true);
  drawCompareChart("chartSponsorship","Producto",d1.filter(d=>d.Familia==="Sponsorship"),d2.filter(d=>d.Familia==="Sponsorship"),y1,y2,true);
  drawCompareChart("chartSocialNetworks","Producto",d1.filter(d=>d.Familia==="Social Networks"),d2.filter(d=>d.Familia==="Social Networks"),y1,y2,true);
  drawCompareChart("chartComercial","Comercial",d1,d2,y1,y2,true);
}

function kpi(container,title,value,pct=""){
  container.innerHTML+=`
    <div class="kpi">
      <h2>‚Ç¨ ${Math.round(value).toLocaleString("es-ES")}</h2>
      <p>${title}</p>
      ${pct}
    </div>`;
}

function drawCompareChart(id,key,d1,d2,label1,label2,isBig=false){
  const s1={}, s2={};
  d1.forEach(d=>s1[d[key]]=(s1[d[key]]||0)+d.ingreso);
  d2.forEach(d=>s2[d[key]]=(s2[d[key]]||0)+d.ingreso);

  let labels=[...new Set([...Object.keys(s1),...Object.keys(s2)])];
  labels.sort((a,b)=>(s1[a]||0)-(s1[b]||0));

  const textBars = labels.map(l => {
      const v1 = s1[l] || 0;
      const v2 = s2[l] || 0;
      if (v2 > 0) {
          const diff = ((v1 - v2) / v2) * 100;
          return ` ${diff >= 0 ? '+' : ''}${Math.round(diff)}%`;
      }
      return "";
  });

  const traces=[{
    y:labels, x:labels.map(l=>Math.round(s1[l]||0)),
    name:label1, type:"bar", orientation:'h', marker:{color:"#38bdf8"},
    text: d2.length ? textBars : "", 
    textposition: 'outside',
    cliponaxis: false
  }];

  if(d2.length){
    traces.push({
      y:labels, x:labels.map(l=>Math.round(s2[l]||0)),
      name:label2, type:"bar", orientation:'h', marker:{color:"#f59e0b"}
    });
  }

  const layout = {
    barmode:"group", margin:{l:isBig?250:150,r:100,t:30,b:50},
    paper_bgcolor:"rgba(0,0,0,0)", plot_bgcolor:"rgba(0,0,0,0)",
    font:{color:"#e5e7eb", size:11}, legend:{orientation:"h",y:-0.05},
    yaxis: { automargin: true },
    xaxis: { ticksuffix: ' ‚Ç¨', gridcolor: '#1f2937' }
  };
  Plotly.newPlot(id,traces,layout,{responsive:true});
}
</script>
</body>
</html>
