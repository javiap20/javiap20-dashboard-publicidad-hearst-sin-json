
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DIGITAL - Facturaci√≥n Display</title>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
<style>
:root{
  --card:#111827;
  --text:#e5e7eb;
  --base:#38bdf8;          /* azul */
  --comp:#f59e0b;          /* amarillo */
  --neg:#f87171;           /* rojo */
  --diffColor:#6ee7b7;     /* verde claro */
  --ok-green: #6ee7b7;
  --totalBg:#1e40af;       /* azul oscuro */
  --siteBg:#fef3c7; 
  --productoBg:#dbeafe; 
  --sectorBg:#fbcfe8; 
  --comercialBg:#d1fae5; 
  --areaBg:#fcd5ce;
}

body{
  margin:0;
  font-family:Inter,Arial,sans-serif;
  background:linear-gradient(180deg,#020617,#0f172a);
  color:var(--text);
}

/* MEN√ö DE NAVEGACI√ìN */
.nav-menu {
  background: #111827;
  padding: 15px;
  text-align: center;
  border-bottom: 1px solid #374151;
  position: sticky;
  top: 0;
  z-index: 1000;
  margin-bottom: 20px;
}
.nav-menu a {
  color: white;
  margin: 0 10px;
  text-decoration: none;
  font-size: 0.9em;
  opacity: 0.8;
}
.nav-menu a:hover { opacity: 1; color: var(--base); }
.nav-menu .active { font-weight: bold; border-bottom: 2px solid var(--base); opacity: 1; }

h1{ text-align:center; margin:20px 0; font-size: 1.6em; }
.container{ max-width:1500px; margin:auto; padding:0 20px 20px 20px; }

.card{
  background:rgba(17,24,39,.9);
  border-radius:14px;
  padding:18px;
  margin-bottom:20px;
}

/* Controles */
.filters select, input[type=file]{
  background:#1f2933; 
  color:var(--text); 
  border:1px solid #1f2937;
  padding:8px 10px; 
  border-radius:8px; 
  margin-right:14px;
}
.filters label{ font-weight:600; margin-right:6px; display:block; margin-top:10px; }
.filtersRow{ display:flex; gap:20px; flex-wrap:wrap; align-items:flex-start; }
.filtersRow div select{ width:220px; font-weight:600; }

#fSite{ background:var(--siteBg); color:#111; }
#fProduct{ background:var(--productoBg); color:#111; }
#fSector{ background:var(--sectorBg); color:#111; }
#fComercial{ background:var(--comercialBg); color:#111; }
#fArea{ background:var(--areaBg); color:#111; }

.checkboxGroup{ display:flex; flex-wrap:wrap; gap:10px; margin-top:10px; }
.checkboxGroup label{ font-size: 0.85em; font-weight:400; color: #cbd5e1; display: flex; align-items: center; gap: 4px; cursor: pointer; }

/* Bloques superiores */
.totalBlock{ background:var(--totalBg); padding:15px; border-radius:12px; margin-top:10px; }
.totalValues{ display:flex; justify-content:space-around; font-size:18px; }
.totalValues div{ text-align:center; }
.totalValues .value{ font-size:22px; font-weight:700; display: block; margin-top: 5px; }
#diffPercent.negative { color: var(--neg); }

/* Bloque de estad√≠sticas en una sola l√≠nea */
.statsBlock{ display:flex; justify-content:center; border-radius:12px; margin:20px 0; gap:10px; flex-wrap:nowrap; }
.subBlock{ border-radius:12px; padding:20px; display:flex; align-items:center; justify-content:center; color: #111; }
.statsBase{ flex:1; background:var(--comp); }
.statsDiff{ flex:0 0 300px; background:var(--diffColor); text-align: center; }
.statsComp{ flex:1; background:var(--base); }

.statsValues{ display:flex; justify-content:center; font-size:15px; gap:20px; flex-wrap:wrap; }
.statsValues div{ text-align:center; }
.statsValues .value{ font-size:18px; font-weight:700; display: block; margin-top: 5px; }
.statsDiff .value.negative{ color:var(--neg); }

.labelBase{ color:#f59e0b; font-weight:700; }
.labelComp{ color:#38bdf8; font-weight:700; }

/* Gr√°fico */
#chartProductsBars{ width:100%; min-height: 400px; }
.notice{ padding:14px; background:#1f2937; border-radius:10px; color:#cbd5e1; margin-top:10px; border: 1px dashed #4b5563; }
</style>
</head>
<body>

<nav class="nav-menu">
    <span style="color: #38bdf8; font-weight: bold; margin-right: 10px; opacity: 0.6;">DIGITAL:</span>
    <a href="digital-datos-graficos.html">Datos</a>
    <a href="digital-facturacion-desglosada.html">Desglose</a>
    <a href="digital-facturacion-por-anunciante.html">Anunciantes</a>
    <a href="digital-display.html" class="active">Display</a>
    <a href="digital-totales-familas-productos.html">Productos</a>
    
    <span style="color: #f59e0b; font-weight: bold; margin-left: 20px; margin-right: 10px; border-left: 1px solid #4b5563; padding-left: 20px;">PRINT:</span>
    <a href="print-datos-graficos.html">Datos</a>
    <a href="print-facturacion-desglosada.html">Desglose</a>
    <a href="print-facturacion-por-anunciante.html">Anunciantes</a>
    
    <a href="index.html" style="margin-left: 20px; border-left: 1px solid #4b5563; padding-left: 20px; color: #fff; opacity: 0.5;">üè† Inicio</a>
</nav>

<h1>DIGITAL - Facturaci√≥n Display</h1>

<div class="container">
  <div class="card">
    <label>Cargar datos manualmente: </label>
    <input type="file" id="fileInput" accept=".json,.xlsx">
    <p id="loadStatus" style="font-size: 0.8em; color: var(--ok-green); margin-top: 10px;">Selecciona un archivo para empezar.</p>
  </div>

  <div id="siteBlock" class="card filters" style="display:none">
    <div class="filtersRow">
      <div><label>Site</label><select id="fSite"></select></div>
      <div><label>Familia Display</label><select id="fProduct"></select></div>
      <div><label>Sector</label><select id="fSector"></select></div>
      <div><label>Comercial</label><select id="fComercial"></select></div>
      <div><label>√Årea</label><select id="fArea"></select></div>
    </div>
  </div>

  <div id="filters" class="card filters" style="display:none">
    <div class="filtersRow">
      <div><label class="labelBase">A√±o base</label><select id="fYear"></select><div class="checkboxGroup" id="monthsBase"></div></div>
      <div><label class="labelComp">A√±o comparaci√≥n</label><select id="fYear2"></select><div class="checkboxGroup" id="monthsComp"></div></div>
    </div>
  </div>

  <div id="totalBlock" class="card" style="display:none">
    <div class="totalBlock">
      <div class="totalValues">
        <div>A√±o base<span id="totalYear1" class="value">0‚Ç¨</span></div>
        <div>A√±o comparaci√≥n<span id="totalYear2" class="value">-</span></div>
        <div>% Diferencia<span id="diffPercent" class="value">-</span></div>
      </div>
    </div>
  </div>

  <div id="statsBlock" class="statsBlock" style="display:none">
      <div class="subBlock statsBase">
        <div class="statsValues">
          <div>Fact. A√±o Base<span id="totalStatsBase" class="value">0‚Ç¨</span></div>
          <div>N¬∫ l√≠neas<span id="linesStatsBase" class="value">0</span></div>
          <div>Presup. medio<span id="avgStatsBase" class="value">0‚Ç¨</span></div>
        </div>
      </div>
      <div class="subBlock statsDiff">
        <div class="statsValues">
          <div>% Crec. Presup. Medio<span id="diffAvgStats" class="value" style="font-size: 1.8em; display:block; margin-top: 5px;">-</span></div>
        </div>
      </div>
      <div class="subBlock statsComp">
        <div class="statsValues">
          <div>Fact. A√±o Comparaci√≥n<span id="totalStatsComp" class="value">-</span></div>
          <div>N¬∫ l√≠neas<span id="linesStatsComp" class="value">-</span></div>
          <div>Presup. medio<span id="avgStatsComp" class="value">-</span></div>
        </div>
      </div>
  </div>

  <div id="chartCardBars" class="card" style="display:none">
    <h2>Ingresos por Producto</h2>
    <div id="chartProductsBars"></div>
    <div id="msgTodos" class="notice" style="display:none">Elige una <b>Familia Display</b> para ver sus productos.</div>
  </div>
</div>

<script>
const MONTHS=["01 Enero","02 Febrero","03 Marzo","04 Abril","05 Mayo","06 Junio","07 Julio","08 Agosto","09 Septiembre","10 Octubre","11 Noviembre","12 Diciembre"];
let rawData=[];
const FAMILIAS_DISPLAY = ["Display", "Programatica Display Directo", "Programatica Display Indirecto", "Video", "Video Programatico Directo", "Video Programatico Indirecto"];

/* ---------- Carga autom√°tica eliminada (sin fetch en onload) ---------- */

/* ---------- Carga manual ---------- */
fileInput.onchange = e => {
  const f = e.target.files[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = ev => {
    const ext = f.name.split(".").pop().toLowerCase();
    if (ext === "json") {
      init(JSON.parse(ev.target.result));
    } else {
      const wb = XLSX.read(ev.target.result, {type:"binary"});
      const ws = wb.Sheets[wb.SheetNames[0]];
      init(XLSX.utils.sheet_to_json(ws));
    }
  };
  f.name.endsWith("json") ? r.readAsText(f) : r.readAsBinaryString(f);
};

/* ---------- Normalizaci√≥n y parseo ---------- */
function normalizeText(s){
  if(!s) return "";
  return String(s)
    .replace(/\u00A0/g," ")
    .trim()
    .replace(/\s+/g," ")
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .toUpperCase();
}
function normalizeMonth(m){
  if(!m) return "";
  const n = String(m).trim().substring(0,2);
  return MONTHS.find(x=>x.startsWith(n)) || "";
}
function num(v){
  if(v==null) return 0;
  const s = String(v)
    .replace(/\u00A0/g," ")
    .replace(/‚Ç¨/g,"")
    .replace(/\s/g,"")
    .replace(/\./g,"")   // quita miles si vienen
    .replace(/,/g,".");  // coma a punto
  const n = Number(s);
  return Number.isFinite(n) ? n : 0;
}

/* ---------- Formateadores s√≥lidos ---------- */
const currencyFormatter = new Intl.NumberFormat('es-ES', {
  useGrouping: true,
  minimumFractionDigits: 0,
  maximumFractionDigits: 0
});
function formatCurrency(n){
  const val = Math.round(Number(n) || 0);
  return (Number.isFinite(val) ? currencyFormatter.format(val) : '0') + '‚Ç¨'; // sin espacio
}
const integerFormatter = new Intl.NumberFormat('es-ES', {
  useGrouping: true,
  maximumFractionDigits: 0
});
function formatInteger(n){
  const val = Number(n || 0);
  return Number.isFinite(val) ? integerFormatter.format(val) : '0';
}

/* ---------- Inicializaci√≥n ---------- */
function init(data){
  rawData = data.map(d => ({
    ingreso:  num(d["Imp.Neto a Comisionar"]),
    A√±o:      normalizeText(d["A√±o inserci√≥n"]),
    Mes:      normalizeMonth(d["Mes inserci√≥n"]),
    Site:     normalizeText(d["Publicaci√≥n"]),
    Familia:  normalizeText(d["Familia"]),
    Producto: normalizeText(d["Producto"]),
    Sector:   normalizeText(d["Sector"]),
    Comercial:normalizeText(d["Comercial"]),
    Area:     normalizeText(d["√ÅREAS"])
  }));

  const populate = (id, arr) => {
    const s = document.getElementById(id);
    s.innerHTML = "<option>Todos</option>" + [...new Set(arr.filter(Boolean))].sort().map(v=>`<option>${v}</option>`).join("");
  };

  populate("fSite", rawData.map(d=>d.Site));
  populate("fProduct", FAMILIAS_DISPLAY.map(f=>f.toUpperCase()));
  populate("fSector", rawData.map(d=>d.Sector));
  populate("fComercial", rawData.map(d=>d.Comercial));
  populate("fArea", rawData.map(d=>d.Area));
  
  const years = [...new Set(rawData.map(d=>d.A√±o))].sort().reverse();
  fYear.innerHTML  = "<option>Todos</option>" + years.map(y=>`<option>${y}</option>`).join("");
  fYear2.innerHTML = "<option>Sin comparar</option>" + years.map(y=>`<option>${y}</option>`).join("");

  document.getElementById("monthsBase").innerHTML = MONTHS.map(m=>`<label><input type="checkbox" value="${m}" onchange="render()"> ${m.slice(3)}</label>`).join("");
  document.getElementById("monthsComp").innerHTML = MONTHS.map(m=>`<label><input type="checkbox" value="${m}" onchange="render()"> ${m.slice(3)}</label>`).join("");

  [fSite,fProduct,fSector,fYear,fYear2,fComercial,fArea].forEach(e=>e.onchange=render);

  ["siteBlock","filters","totalBlock","statsBlock","chartCardBars"].forEach(id=>document.getElementById(id).style.display="block");
  document.getElementById("statsBlock").style.display="flex"; // Forzar flex

  render();
}

/* ---------- Render ---------- */
function getSelectedMonths(id){
  const sel = Array.from(document.getElementById(id).querySelectorAll("input:checked")).map(i=>i.value);
  return sel.length ? sel : MONTHS;
}

function render(){
  const site = fSite.value.toUpperCase(),
        prod = fProduct.value.toUpperCase(),
        sect = fSector.value.toUpperCase(),
        y1   = fYear.value.toUpperCase(),
        y2   = fYear2.value.toUpperCase(),
        com  = fComercial.value.toUpperCase(),
        area = fArea.value.toUpperCase();

  const m1 = getSelectedMonths("monthsBase"),
        m2 = getSelectedMonths("monthsComp");

  const filter = (y, months) => rawData.filter(d => 
     (y==="TODOS" || d.A√±o===y) &&
     months.includes(d.Mes) &&
     (site==="TODOS" || d.Site===site) &&
     (prod==="TODOS" || d.Familia===prod) &&
     (sect==="TODOS" || d.Sector===sect) &&
     (com==="TODOS" || d.Comercial===com) &&
     (area==="TODOS" || d.Area===area)
  );

  const d1 = filter(y1, m1);
  const d2 = (fYear2.value!=="Sin comparar") ? filter(y2, m2) : [];

  const calc = (data) => {
    const total = data.reduce((a,b)=>a+b.ingreso,0);
    const lines = data.filter(d=>d.ingreso>0).length;
    const avg   = lines ? (total / lines) : 0;
    return { total, lines, avg };
  };

  const s1 = calc(d1), s2 = calc(d2);

  // Totales superiores
  totalYear1.textContent     = formatCurrency(s1.total);
  totalStatsBase.textContent = formatCurrency(s1.total);
  linesStatsBase.textContent = formatInteger(s1.lines);
  avgStatsBase.textContent   = formatCurrency(s1.avg);

  if(fYear2.value!=="Sin comparar"){
    totalYear2.textContent     = formatCurrency(s2.total);
    totalStatsComp.textContent = formatCurrency(s2.total);
    linesStatsComp.textContent = formatInteger(s2.lines);
    avgStatsComp.textContent   = formatCurrency(s2.avg);
    
    const dPct = s2.total ? Math.round((s1.total/s2.total - 1)*100) : 0;
    diffPercent.textContent = (dPct > 0 ? "+" : "") + dPct + "%";
    diffPercent.className   = "value" + (dPct < 0 ? " negative" : "");

    const aPct = s2.avg ? Math.round((s1.avg/s2.avg - 1)*100) : 0;
    diffAvgStats.textContent = (aPct > 0 ? "+" : "") + aPct + "%";
    diffAvgStats.style.color = aPct < 0 ? "var(--neg)" : "#111";
  } else {
    totalYear2.textContent     = "-";
    totalStatsComp.textContent = "-";
    linesStatsComp.textContent = "-";
    avgStatsComp.textContent   = "-";
    diffPercent.textContent    = "-";
    diffPercent.className      = "value";
    diffAvgStats.textContent   = "-";
    diffAvgStats.style.color   = "#111";
  }

  // Gr√°fico de barras por producto
  const div = document.getElementById("chartProductsBars");
  const famSel = fProduct.value.toUpperCase();

  if(famSel === "TODOS") {
    document.getElementById("msgTodos").style.display = "block";
    Plotly.purge(div);
  } else {
    document.getElementById("msgTodos").style.display = "none";
    
    const m1_map = new Map();
    d1.forEach(d => m1_map.set(d.Producto, (m1_map.get(d.Producto)||0) + d.ingreso));
    const m2_map = new Map();
    d2.forEach(d => m2_map.set(d.Producto, (m2_map.get(d.Producto)||0) + d.ingreso));

    const sortedNames = Array.from(m1_map.entries()).sort((a,b) => a[1] - b[1]).map(x => x[0]);
    const namesInD2Only = Array.from(m2_map.keys()).filter(n => !m1_map.has(n));
    const finalNames = [...namesInD2Only, ...sortedNames];

    const textBars = finalNames.map(n => {
      if(fYear2.value === "Sin comparar") return "";
      const v1 = m1_map.get(n) || 0;
      const v2 = m2_map.get(n) || 0;
      if(v2 > 0) {
          const diff = Math.round(((v1 / v2) - 1) * 100);
          return ` ${diff > 0 ? '+' : ''}${diff}%`;
      }
      return "";
    });

    const traces = [{
      y: finalNames,
      x: finalNames.map(n => m1_map.get(n) || 0),
      name: fYear.value,
      type: 'bar',
      orientation: 'h',
      marker: {color: "#38bdf8"},
      text: textBars,
      textposition: 'outside',
      cliponaxis: false,
      hovertemplate: '%{x:,.0f}‚Ç¨<extra></extra>'
    }];

    if(fYear2.value!=="Sin comparar") {
      traces.push({
        y: finalNames,
        x: finalNames.map(n => m2_map.get(n) || 0),
        name: fYear2.value,
        type: 'bar',
        orientation: 'h',
        marker: {color: "#f59e0b"},
        hovertemplate: '%{x:,.0f}‚Ç¨<extra></extra>'
      });
    }

    div.style.height = Math.max(400, (150 + finalNames.length * 45)) + "px";
    
    Plotly.newPlot(div, traces, {
      paper_bgcolor:"rgba(0,0,0,0)", 
      plot_bgcolor:"rgba(0,0,0,0)", 
      font:{color:"#eee"},
      margin:{l:280, r:100, t:20, b:50}, 
      barmode: 'group',
      xaxis: { gridcolor: '#1f2937', tickformat: ',.0f', ticksuffix: '‚Ç¨', automargin: true },
      yaxis: { automargin: true },
      separators: '.,' // fuerza punto miles y coma decimal
    }, {responsive: true});
  }
}
</script>
</body>
</html>
